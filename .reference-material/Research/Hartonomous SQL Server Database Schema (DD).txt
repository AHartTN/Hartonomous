-- This script creates the core database schema for the Hartonomous project.
-- It serves as the central "system of record" for all project data.

-- Master Table for all documents and files.
-- This table is the central hub for the entire architecture.
CREATE TABLE [dbo].[Documents] (
    [DocumentID] UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    [FileName] NVARCHAR(255) NOT NULL,
    [FileExtension] NVARCHAR(10) NOT NULL,
    [Content] VARBINARY(MAX) NULL, -- Stores the raw file content
    [VectorEmbedding] VECTOR(1536) NULL, -- SQL Server 2025 native VECTOR data type for RAG
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [AuthorID] UNIQUEIDENTIFIER NOT NULL, -- Foreign key to the Authors table
    [IsActive] BIT NOT NULL DEFAULT 1,
    [Metadata] NVARCHAR(MAX) NOT NULL -- Stores semi-structured metadata as JSON
        CHECK (ISJSON([Metadata]) = 1)
);
-- Create a DiskANN vector index for high-performance semantic search.
CREATE VECTOR INDEX IX_Documents_VectorEmbedding ON [dbo].[Documents](VectorEmbedding)
WITH (
    METHOD = 'DISKANN'
);

-- Table for tracking authors and users.
CREATE TABLE [dbo].[Authors] (
    [AuthorID] UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    [AuthorName] NVARCHAR(100) NOT NULL,
    [Email] NVARCHAR(255) NOT NULL UNIQUE,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE()
);

-- Table for a simple, structured metadata key-value store.
-- This is in addition to the flexible JSON column on the Documents table.
CREATE TABLE [dbo].[StructuredMetadata] (
    [MetadataID] UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    [DocumentID] UNIQUEIDENTIFIER NOT NULL,
    [MetadataKey] NVARCHAR(100) NOT NULL,
    [MetadataValue] NVARCHAR(MAX) NOT NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT FK_StructuredMetadata_Documents FOREIGN KEY ([DocumentID]) REFERENCES [dbo].[Documents]([DocumentID])
);

-- Table to store pre-trained models for in-database use.
-- This column is FILESTREAM-enabled for efficient, low-latency access to large files.
CREATE TABLE [dbo].[Models] (
    [ModelID] UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    [ModelName] NVARCHAR(255) NOT NULL,
    [ModelBinary] VARBINARY(MAX) FILESTREAM NOT NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE()
);

-- Table to store vector embeddings generated by SQL CLR or other processes.
-- This table is specifically for the outputs of the SQL CLR model training pipeline.
CREATE TABLE [dbo].[VectorEmbeddings] (
    [EmbeddingID] UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    [DocumentID] UNIQUEIDENTIFIER NOT NULL,
    [ModelID] UNIQUEIDENTIFIER NOT NULL,
    [VectorEmbedding] VARBINARY(MAX) NOT NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT FK_VectorEmbeddings_Documents FOREIGN KEY ([DocumentID]) REFERENCES [dbo].[Documents]([DocumentID]),
    CONSTRAINT FK_VectorEmbeddings_Models FOREIGN KEY ([ModelID]) REFERENCES [dbo].[Models]([ModelID])
);
